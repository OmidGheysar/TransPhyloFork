<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simultaneous Inference of Multiple Transmission Trees • TransPhylo</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Simultaneous Inference of Multiple Transmission Trees">
<meta property="og:description" content="TransPhylo">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">TransPhylo</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.4.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/TransPhylo.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Simulate.html">Simulation of outbreak data</a>
    </li>
    <li>
      <a href="../articles/infer.html">Inference of transmission tree from a dated phylogeny</a>
    </li>
    <li>
      <a href="../articles/multitree.html">Simultaneous Inference of Multiple Transmission Trees</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Simultaneous Inference of Multiple Transmission Trees</h1>
                        <h4 class="author">Yuanwei Xu</h4>
            
            <h4 class="date">2020-05-08</h4>
      
      
      <div class="hidden name"><code>multitree.Rmd</code></div>

    </div>

    
    
<p>TransPhylo has been used successfuly to draw inference on transmission events from a timed phylogenetic tree. In this tutorial, we demonstrate an extension, <code>infer_multittree_shar_param</code>, that allows simultaneous inference of multiple transmission trees from corresponding phylogenetic trees, with the possibility of sharing any subset of TransPhylo parameters. This may be useful when one is faced with multiple transmission clusters, which may be define genetically through SNP cutoff coupled with epidemiological data, and it may be the case that jointly analyzing these clusters is desirable assuming they share the same underlying epidemiological parameters. It is also computational efficient since fewer number of parameters will be estimated. Another use case might be that sometimes it is difficult to summarise a single representative tree from a collection of phylogenetic trees, such as BEAST trees. In this case, one could run multiple tree inference on a subsample of BEAST trees. This has additional benefit of incorporating some degree of uncertainty from the BEAST posterior.</p>
<div id="simulated-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulated-data" class="anchor"></a>Simulated Data</h2>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ape</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">TransPhylo</span>)</pre></body></html></div>
<p>We simulate two outbreaks with the same set of parameters defined below, using TransPhylo’s outbreak simulator.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">neg</span> <span class="kw">&lt;-</span> <span class="fl">100</span>/<span class="fl">365</span>
<span class="no">off.r</span> <span class="kw">&lt;-</span> <span class="fl">1.5</span>
<span class="no">w.shape</span> <span class="kw">&lt;-</span> <span class="fl">10</span>
<span class="no">w.scale</span> <span class="kw">&lt;-</span> <span class="fl">0.1</span>
<span class="no">ws.shape</span> <span class="kw">&lt;-</span> <span class="no">w.shape</span>
<span class="no">ws.scale</span> <span class="kw">&lt;-</span> <span class="no">w.scale</span>
<span class="no">pi</span> <span class="kw">&lt;-</span> <span class="fl">0.8</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1234</span>)
<span class="no">simu1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/simulateOutbreak.html">simulateOutbreak</a></span>(<span class="kw">neg</span><span class="kw">=</span><span class="no">neg</span>, <span class="kw">off.r</span><span class="kw">=</span><span class="no">off.r</span>, <span class="kw">pi</span><span class="kw">=</span><span class="no">pi</span>, <span class="kw">w.shape</span><span class="kw">=</span><span class="no">w.shape</span>,
                         <span class="kw">w.scale</span><span class="kw">=</span><span class="no">w.scale</span>, <span class="kw">dateStartOutbreak</span><span class="kw">=</span><span class="fl">2000</span>,<span class="kw">dateT</span><span class="kw">=</span><span class="fl">2005</span>)
<span class="no">simu2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/simulateOutbreak.html">simulateOutbreak</a></span>(<span class="kw">neg</span><span class="kw">=</span><span class="no">neg</span>, <span class="kw">off.r</span><span class="kw">=</span><span class="no">off.r</span>, <span class="kw">pi</span><span class="kw">=</span><span class="no">pi</span>, <span class="kw">w.shape</span><span class="kw">=</span><span class="no">w.shape</span>,
                         <span class="kw">w.scale</span><span class="kw">=</span><span class="no">w.scale</span>, <span class="kw">dateStartOutbreak</span><span class="kw">=</span><span class="fl">2000</span>,<span class="kw">dateT</span><span class="kw">=</span><span class="fl">2005</span>)</pre></body></html></div>
<p>We plot the combined phylogenetic and transmission trees, each colour represents an infected host, colour changes when there is a transmission event.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">simu1</span>)</pre></body></html></div>
<p><img src="multitree_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">simu2</span>)</pre></body></html></div>
<p><img src="multitree_files/figure-html/unnamed-chunk-1-2.png" width="700"></p>
</div>
<div id="run-single-and-multiple-tree-inference-algorithm" class="section level2">
<h2 class="hasAnchor">
<a href="#run-single-and-multiple-tree-inference-algorithm" class="anchor"></a>Run single and multiple tree inference algorithm</h2>
<p>The corresponding phylogenetic trees can be extracted. We first use single tree routine <code>inferTTree</code> separately for each phylogenetic tree, then use the multiple tree routine <code>infer_multittree_shar_param</code> to jointly infer transmission trees while sharing all parameters. The second parameter of offspring distribution, <code>off.p</code>, has no effect because it is not updated by default, but we still include it in the set of shared parameters.</p>
<p>We compare the posterior estimates of the parameters with those obtained from running <code>inferTTree</code> separately. In the multiple tree routine, we specify the two parameters of beta prior to be both 1, in order to get a uniform prior for the sampling rate that is consistent with <code>inferTTree</code>, where uniform prior is assumed.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">ptree1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/extractPTree.html">extractPTree</a></span>(<span class="no">simu1</span>)
<span class="no">ptree2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/extractPTree.html">extractPTree</a></span>(<span class="no">simu2</span>)

<span class="no">iters</span> <span class="kw">&lt;-</span> <span class="fl">2e3</span>; <span class="no">thin</span> <span class="kw">&lt;-</span> <span class="fl">10</span>
<span class="no">record_tp1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/inferTTree.html">inferTTree</a></span>(<span class="no">ptree1</span>, <span class="no">w.shape</span>, <span class="no">w.scale</span>, <span class="no">ws.shape</span>, <span class="no">ws.scale</span>,
                         <span class="kw">mcmcIterations</span> <span class="kw">=</span> <span class="no">iters</span>, <span class="kw">thinning</span> <span class="kw">=</span> <span class="no">thin</span>, <span class="kw">dateT</span> <span class="kw">=</span> <span class="fl">2005</span>)
<span class="no">record_tp2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/inferTTree.html">inferTTree</a></span>(<span class="no">ptree2</span>, <span class="no">w.shape</span>, <span class="no">w.scale</span>, <span class="no">ws.shape</span>, <span class="no">ws.scale</span>,
                         <span class="kw">mcmcIterations</span> <span class="kw">=</span> <span class="no">iters</span>, <span class="kw">thinning</span> <span class="kw">=</span> <span class="no">thin</span>, <span class="kw">dateT</span> <span class="kw">=</span> <span class="fl">2005</span>)
<span class="no">record_tpj</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/infer_multittree_share_param.html">infer_multittree_share_param</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">ptree1</span>,<span class="no">ptree2</span>), <span class="no">w.shape</span>, <span class="no">w.scale</span>, <span class="no">ws.shape</span>, <span class="no">ws.scale</span>,
                                    <span class="kw">mcmcIterations</span> <span class="kw">=</span> <span class="no">iters</span>, <span class="kw">thinning</span> <span class="kw">=</span> <span class="no">thin</span>, <span class="kw">dateT</span> <span class="kw">=</span> <span class="fl">2005</span>,
                                    <span class="kw">share</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"neg"</span>, <span class="st">"off.r"</span>, <span class="st">"off.p"</span>, <span class="st">"pi"</span>))</pre></body></html></div>
<p>Take the last 50% trees. Note that the multiple tree inference returns list of length two where each element contains the result corresponding to the input phylogenetic tree.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">begin</span> <span class="kw">&lt;-</span> (<span class="no">iters</span> * <span class="fl">0.5</span>) / <span class="no">thin</span> + <span class="fl">1</span>
<span class="no">end</span> <span class="kw">&lt;-</span> <span class="no">iters</span> / <span class="no">thin</span>
<span class="no">record_tp1</span> <span class="kw">&lt;-</span> <span class="no">record_tp1</span>[<span class="no">begin</span>:<span class="no">end</span>]
<span class="no">record_tp2</span> <span class="kw">&lt;-</span> <span class="no">record_tp2</span>[<span class="no">begin</span>:<span class="no">end</span>]
<span class="no">record_tpj</span><span class="kw">[[</span><span class="fl">1</span>]] <span class="kw">&lt;-</span> <span class="no">record_tpj</span><span class="kw">[[</span><span class="fl">1</span>]][<span class="no">begin</span>:<span class="no">end</span>]
<span class="no">record_tpj</span><span class="kw">[[</span><span class="fl">2</span>]] <span class="kw">&lt;-</span> <span class="no">record_tpj</span><span class="kw">[[</span><span class="fl">2</span>]][<span class="no">begin</span>:<span class="no">end</span>]</pre></body></html></div>
</div>
<div id="compare-parameter-estimates" class="section level2">
<h2 class="hasAnchor">
<a href="#compare-parameter-estimates" class="anchor"></a>Compare parameter estimates</h2>
<p>We visualize the estimates from the three runs. Note that because we have shared the parameters, we can pick either element from the list result <code>record_tpj</code>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">get_param_estimates</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">record</span>, <span class="no">p</span>){
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">record</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span><span class="kw">[[</span><span class="no">p</span>]])
}

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">run</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"tp1"</span>,<span class="st">"tp2"</span>,<span class="st">"tp_multitree"</span>), <span class="kw">each</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">record_tp1</span>)),
           <span class="kw">pi</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu">get_param_estimates</span>(<span class="no">record_tp1</span>, <span class="st">"pi"</span>),
                  <span class="fu">get_param_estimates</span>(<span class="no">record_tp2</span>, <span class="st">"pi"</span>),
                  <span class="fu">get_param_estimates</span>(<span class="no">record_tpj</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="st">"pi"</span>)),
           <span class="kw">off.r</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu">get_param_estimates</span>(<span class="no">record_tp1</span>, <span class="st">"off.r"</span>),
                     <span class="fu">get_param_estimates</span>(<span class="no">record_tp2</span>, <span class="st">"off.r"</span>),
                     <span class="fu">get_param_estimates</span>(<span class="no">record_tpj</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="st">"off.r"</span>)),
           <span class="kw">neg</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu">get_param_estimates</span>(<span class="no">record_tp1</span>, <span class="st">"neg"</span>),
                   <span class="fu">get_param_estimates</span>(<span class="no">record_tp2</span>, <span class="st">"neg"</span>),
                   <span class="fu">get_param_estimates</span>(<span class="no">record_tpj</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="st">"neg"</span>)))</pre></body></html></div>
<p>In this example where we explictly set the parameters when simulating the outbreaks, we see that the posterior estimates from the multiple tree inference generally have lower variance than those resulting from single tree inference. The true parameter values are shown in gray reference line.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span>(<span class="no">df</span>$<span class="no">pi</span>~<span class="no">df</span>$<span class="no">run</span>,<span class="kw">ylab</span><span class="kw">=</span><span class="st">'pi'</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">4</span>),<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0.8</span>,<span class="fl">2</span>),<span class="kw">col</span><span class="kw">=</span><span class="st">'grey'</span>)</pre></body></html></div>
<p><img src="multitree_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span>(<span class="no">df</span>$<span class="no">off.r</span>~<span class="no">df</span>$<span class="no">run</span>,<span class="kw">ylab</span><span class="kw">=</span><span class="st">'off.r'</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">4</span>),<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1.5</span>,<span class="fl">2</span>),<span class="kw">col</span><span class="kw">=</span><span class="st">'grey'</span>)</pre></body></html></div>
<p><img src="multitree_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span>(<span class="no">df</span>$<span class="no">neg</span>~<span class="no">df</span>$<span class="no">run</span>,<span class="kw">ylab</span><span class="kw">=</span><span class="st">'Ne*g'</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">4</span>),<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">100</span>/<span class="fl">365</span>,<span class="fl">2</span>),<span class="kw">col</span><span class="kw">=</span><span class="st">'grey'</span>)</pre></body></html></div>
<p><img src="multitree_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Xavier Didelot.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
